<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="color-scheme" content="light only">
<title>Questly</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,800;9..144,900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{color-scheme:light only;--bg:#fafaf8;--surface:#fff;--sh:#f5f5f2;--border:#e8e8e4;--bl:#f0f0ec;--text:#1a1a18;--t2:#6b6b64;--t3:#9b9b94;--accent:#e85d2a;--al:#fef0eb;--green:#2d9b5a;--gl:#edf8f1;--red:#d44040;--rl:#fdf0f0;--gold:#c49a20;--r:14px}
@media(prefers-color-scheme:dark){:root{color-scheme:light only;--bg:#fafaf8;--surface:#fff;--text:#1a1a18;--t2:#6b6b64;--t3:#9b9b94}}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100dvh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
button{font-family:'Inter',sans-serif;cursor:pointer}
.app{max-width:420px;margin:0 auto;min-height:100dvh;position:relative}
.screen{display:none;min-height:100dvh}.screen.active{display:flex;flex-direction:column}
.fade{animation:fi .45s cubic-bezier(.16,1,.3,1)}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.btn-p{width:100%;padding:14px;border-radius:var(--r);border:none;background:var(--text);color:#fff;font-size:15px;font-weight:600;transition:all .15s;letter-spacing:-.2px}
.btn-p:hover{opacity:.9}.btn-p:active{transform:scale(.98)}.btn-p:disabled{opacity:.35;pointer-events:none}
.btn-o{padding:12px;border-radius:var(--r);border:1px solid var(--border);background:transparent;font-size:13px;font-weight:500;color:var(--t2);transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-o:hover{background:var(--sh)}
.btn-t{background:none;border:none;font-size:14px;font-weight:400;color:var(--t3);padding:8px 16px}.btn-t:hover{color:var(--t2)}
.header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;position:sticky;top:0;z-index:50;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(250,250,248,.88)}
.logo{font-family:'Fraunces',serif;font-size:20px;font-weight:900;letter-spacing:-.3px}
.h-right{display:flex;align-items:center;gap:10px}
.h-pill{font-size:13px;font-weight:600;color:var(--t2);display:flex;align-items:center;gap:4px;background:var(--sh);padding:6px 12px;border-radius:100px}
.h-pill .v{color:var(--accent)}.h-pill .xv{color:var(--gold)}
.home-body{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 20px 40px;text-align:center}
.home-headline{font-family:'Fraunces',serif;font-size:32px;font-weight:900;letter-spacing:-.5px;margin-bottom:8px}
.home-sub{font-size:15px;font-weight:300;color:var(--t2);margin-bottom:36px;line-height:1.5;max-width:300px}
.home-cta{width:100%;max-width:280px;margin-bottom:12px}
.home-save{width:100%;max-width:280px;margin-bottom:12px}
.home-save .btn-o{width:100%;background:var(--al);border-color:var(--accent);color:var(--accent);font-weight:600}
.htp-btn{font-size:13px;font-weight:400;color:var(--t3);background:none;border:none;cursor:pointer;padding:8px 0;text-decoration:underline;text-underline-offset:3px}.htp-btn:hover{color:var(--t2)}
.play-body{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 20px 32px}
.play-title{font-size:18px;font-weight:700;margin-bottom:4px;letter-spacing:-.3px}
.play-sub{font-size:13px;color:var(--t3);margin-bottom:16px;font-weight:300}
.board-wrapper{width:100%;max-width:320px;margin:0 auto 20px}
.board{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;aspect-ratio:1;width:100%}
.tile{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all .2s;position:relative;-webkit-tap-highlight-color:transparent;user-select:none;overflow:hidden}
@media(hover:hover){.tile:hover:not(.claimed):not(.locked){border-color:#d0d0cc;background:var(--sh)}}
@media(hover:none){.tile:hover{border-color:var(--border)!important;background:var(--surface)!important}}
.tile:active:not(.claimed):not(.locked){transform:scale(.96)}
.tile .tile-icon{font-size:32px;line-height:1;transition:all .3s}
.tile .tile-cat{font-size:9px;font-weight:500;color:var(--t3);margin-top:2px;text-transform:uppercase;letter-spacing:.4px;max-width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.tile .tile-label{font-size:8px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.5px;margin-top:1px}
.tile.x{background:var(--gl);border-color:var(--green)}.tile.x .tile-icon{color:var(--green)}
.tile.o{background:var(--rl);border-color:var(--red)}.tile.o .tile-icon{color:var(--red)}
.tile.skipped{background:#fff8f0;border-color:var(--accent);border-style:dashed;cursor:pointer;opacity:1}
.tile.skipped .tile-icon{color:var(--accent);font-size:11px;font-weight:500;font-family:'Inter',sans-serif}
.tile.skipped .tile-cat{color:var(--accent);opacity:1;font-weight:600}
.tile.skipped .tile-label{color:var(--t3)}
.tile.locked{pointer-events:none}
.tile.win-highlight{animation:winPulse .6s ease infinite alternate;box-shadow:0 0 0 3px var(--green)}
@keyframes winPulse{from{transform:scale(1)}to{transform:scale(1.04)}}
.done-msg{background:var(--gl);border:1px solid var(--green);border-radius:var(--r);padding:16px;margin-bottom:16px;width:100%;max-width:320px}
.done-msg.loss{background:var(--rl);border-color:var(--red)}
.done-msg .dm-title{font-size:15px;font-weight:600;color:var(--green);margin-bottom:2px}
.done-msg.loss .dm-title{color:var(--red)}
.done-msg .dm-sub{font-size:13px;font-weight:300;color:var(--t2)}
.q-overlay{display:none;position:fixed;inset:0;z-index:100;background:rgba(250,250,248,.97);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.q-overlay.active{display:flex;flex-direction:column}
.q-inner{max-width:420px;margin:0 auto;width:100%;flex:1;display:flex;flex-direction:column;padding:20px;overflow-y:auto}
.q-timer-bar{width:100%;height:4px;background:var(--bl);border-radius:100px;overflow:hidden;margin-bottom:20px;flex-shrink:0}
.q-timer-fill{height:100%;background:var(--accent);border-radius:100px;transition:width .1s linear;width:100%}
.q-timer-fill.urgent{background:var(--red)}
.q-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.q-cat{display:inline-flex;align-items:center;gap:6px;background:var(--sh);padding:6px 14px;border-radius:100px;font-size:12px;font-weight:500;color:var(--t2);text-transform:uppercase;letter-spacing:.3px}
.q-move{font-size:12px;font-weight:400;color:var(--t3)}
.q-text{font-size:18px;font-weight:600;line-height:1.5;margin-bottom:28px;letter-spacing:-.2px}
.q-opts{display:flex;flex-direction:column;gap:8px;margin-bottom:24px}
.q-opt{background:var(--surface);border:2px solid var(--border);border-radius:var(--r);padding:14px 16px;font-size:15px;font-weight:400;color:var(--text);display:flex;align-items:center;gap:12px;text-align:left;transition:all .15s;width:100%;-webkit-tap-highlight-color:transparent}
@media(hover:hover){.q-opt:hover:not(.off):not(.correct):not(.wrong){border-color:#d0d0cc;background:var(--sh)}}
.q-opt:active:not(.off){transform:scale(.985)}
.q-key{width:28px;height:28px;border-radius:8px;background:var(--bg);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--t3);flex-shrink:0;transition:all .15s}
.q-opt.correct{border-color:var(--green);background:var(--gl)}.q-opt.correct .q-key{background:var(--green);color:#fff;border-color:var(--green)}
.q-opt.wrong{border-color:var(--red);background:var(--rl)}.q-opt.wrong .q-key{background:var(--red);color:#fff;border-color:var(--red)}
.q-opt.off{pointer-events:none;opacity:.25}
.q-opt.reveal{border-color:var(--green);background:var(--gl);opacity:1!important}.q-opt.reveal .q-key{background:var(--green);color:#fff;border-color:var(--green)}
.q-opt.fifty-hidden{display:none}
.lifelines{display:flex;gap:8px;margin-top:auto;padding-top:16px}
.ll-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 8px;border-radius:var(--r);border:1px solid var(--border);background:var(--surface);font-size:12px;font-weight:500;color:var(--t2);transition:all .15s}
@media(hover:hover){.ll-btn:hover:not(:disabled){background:var(--sh);border-color:#d0d0cc}}
.ll-btn:disabled{opacity:.3;pointer-events:none}
.ll-btn .ll-icon{font-size:18px}.ll-btn .ll-cost{font-size:10px;color:var(--t3);font-weight:400}
.res{flex:1;display:flex;flex-direction:column;align-items:center;padding:40px 20px;text-align:center}
.r-emoji{font-size:48px;margin-bottom:16px;animation:pop .5s cubic-bezier(.16,1,.3,1)}
@keyframes pop{0%{transform:scale(0);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
.r-title{font-size:22px;font-weight:700;margin-bottom:4px;letter-spacing:-.3px}
.r-sub{font-size:14px;font-weight:300;color:var(--t2);margin-bottom:24px;line-height:1.6;max-width:280px}
.r-board-mini{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;width:120px;margin:0 auto 24px}
.r-cell{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;border:1px solid var(--border)}
.r-cell.rx{background:var(--gl);color:var(--green);border-color:var(--green)}
.r-cell.ro{background:var(--rl);color:var(--red);border-color:var(--red)}
.r-cell.re{background:var(--sh);color:var(--t3)}
.r-moves{font-size:14px;font-weight:400;color:var(--t2);margin-bottom:20px}
.r-streak-box{background:var(--al);border-radius:var(--r);padding:20px;margin-bottom:20px;width:100%;max-width:300px}
.r-streak-num{font-size:36px;font-weight:700;color:var(--accent);line-height:1}
.r-streak-label{font-size:13px;font-weight:500;margin-top:4px}
.r-xp-line{font-size:13px;font-weight:300;color:var(--t3);margin-bottom:16px}.r-xp-line strong{color:var(--gold);font-weight:600}
.r-bonus-msg{font-size:13px;color:var(--t2);font-weight:400;background:var(--sh);padding:12px 16px;border-radius:var(--r);margin-bottom:20px;max-width:300px;width:100%;line-height:1.5}
.r-cd{font-size:13px;font-weight:300;color:var(--t3);margin-bottom:24px}.r-cd .time{color:var(--red);font-weight:600;font-variant-numeric:tabular-nums}
.r-actions{max-width:300px;width:100%;display:flex;flex-direction:column;gap:8px}
.modal-ol{display:none;position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px}.modal-ol.active{display:flex}
.modal-box{background:#fff;border-radius:20px;padding:28px 24px;max-width:380px;width:100%;max-height:80vh;overflow-y:auto;position:relative;animation:mIn .4s cubic-bezier(.16,1,.3,1)}
@keyframes mIn{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-close{position:absolute;top:16px;right:16px;background:var(--sh);border:none;width:32px;height:32px;border-radius:50%;font-size:16px;color:var(--t2);display:flex;align-items:center;justify-content:center;cursor:pointer}.modal-close:hover{background:var(--border)}
.modal-title{font-family:'Fraunces',serif;font-size:22px;font-weight:900;margin-bottom:20px;letter-spacing:-.3px}
.modal-section{margin-bottom:18px}.modal-section h3{font-size:14px;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px}.modal-section p{font-size:13px;font-weight:300;color:var(--t2);line-height:1.7}
.tut-ol{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:250;align-items:center;justify-content:center;padding:20px}.tut-ol.active{display:flex}
.tut-box{background:#fff;border-radius:20px;padding:32px 24px;max-width:340px;width:100%;text-align:center;animation:mIn .5s cubic-bezier(.16,1,.3,1)}
.tut-emoji{font-size:40px;margin-bottom:12px}.tut-title{font-family:'Fraunces',serif;font-size:24px;font-weight:900;margin-bottom:8px}
.tut-desc{font-size:14px;font-weight:300;color:var(--t2);line-height:1.7;margin-bottom:24px}
.tut-steps{text-align:left;margin-bottom:24px}.tut-step{display:flex;gap:10px;margin-bottom:12px;font-size:13px;color:var(--t2);line-height:1.5}
.tut-step-num{width:24px;height:24px;border-radius:50%;background:var(--text);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.18);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:200;align-items:flex-end;justify-content:center}.overlay.active{display:flex}
.sheet{background:#fff;border-radius:16px 16px 0 0;padding:24px;max-width:420px;width:100%;animation:mIn .4s cubic-bezier(.16,1,.3,1)}
.s-handle{width:32px;height:4px;background:var(--border);border-radius:100px;margin:0 auto 20px}
.s-title{font-size:18px;font-weight:600;text-align:center;margin-bottom:4px}
.s-desc{font-size:14px;font-weight:300;color:var(--t2);text-align:center;margin-bottom:24px}
.s-dismiss{background:none;border:none;color:var(--t3);font-size:13px;font-weight:400;cursor:pointer;margin-top:8px;width:100%;padding:8px;text-align:center}
.login-hl{display:flex;gap:8px;margin-bottom:24px}.lh-item{flex:1;background:var(--bg);border-radius:var(--r);padding:12px 8px;text-align:center}
.lh-ic{font-size:18px;margin-bottom:4px}.lh-tx{font-size:11px;font-weight:400;color:var(--t3)}
.ph-input{width:100%;padding:12px 16px;border-radius:var(--r);border:1px solid var(--border);font-size:15px;font-weight:400;background:var(--bg);color:var(--text);outline:none;font-family:'Inter',sans-serif;margin-bottom:12px}
.ph-input:focus{border-color:var(--text)}.ph-input::placeholder{color:var(--t3);font-weight:300}
.otp-g{display:none;flex-direction:column;gap:12px}.otp-g.active{display:flex}
.otp-note{font-size:13px;font-weight:300;color:var(--t2);text-align:center}
.otp-resend{background:none;border:none;color:var(--accent);font-weight:500;cursor:pointer;font-size:13px}
.login-terms{font-size:11px;font-weight:300;color:var(--t3);text-align:center;margin-top:16px}.login-terms a{color:var(--t2)}
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--text);color:#fff;padding:10px 20px;border-radius:100px;font-size:13px;font-weight:500;z-index:999;transition:transform .35s cubic-bezier(.16,1,.3,1);white-space:nowrap}.toast.show{transform:translateX(-50%) translateY(0)}
.confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:300;overflow:hidden}
.confetti-piece{position:absolute;top:-20px;width:10px;height:10px;border-radius:2px;animation:cFall 2.5s ease-in forwards}
@keyframes cFall{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
@keyframes shake{20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}}.shake{animation:shake .25s ease}
@keyframes claimA{0%{transform:scale(0) rotate(-10deg);opacity:0}60%{transform:scale(1.2) rotate(3deg)}100%{transform:scale(1) rotate(0);opacity:1}}.claim-anim .tile-icon{animation:claimA .4s cubic-bezier(.16,1,.3,1)}
</style>
<script>!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
posthog.init("phc_UxeoAAlu2hyrfoJf9CrLKX4ySqWiYYQJ5ROsHwyhjx",{api_host:"https://app.posthog.com",capture_pageview:false});</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="app">
<div class="screen" id="sHome"><div class="header"><div class="logo">Questly</div><div class="h-right" id="hRight"></div></div><div class="home-body" id="homeBody"></div></div>
<div class="screen" id="sPlay"><div class="header"><div class="logo">Questly</div><div class="h-right" id="hRightPlay"></div></div><div class="play-body" id="playBody"></div></div>
<div class="screen" id="sRes"><div class="header"><div class="logo">Questly</div><div class="h-right" id="hRightRes"></div></div><div class="res fade" id="resBody"></div></div>
</div>
<div class="q-overlay" id="qOverlay"><div class="q-inner"><div class="q-timer-bar"><div class="q-timer-fill" id="qTimerFill"></div></div><div class="q-header"><div class="q-cat" id="qCat"></div><div class="q-move" id="qMove"></div></div><div class="q-text" id="qText"></div><div class="q-opts" id="qOpts"></div><div class="lifelines" id="lifelines"><button class="ll-btn" id="llFifty" onclick="useFiftyFifty()"><span class="ll-icon">üéØ</span><span>50:50</span><span class="ll-cost">80 XP</span></button><button class="ll-btn" id="llSkip" onclick="useSkipTile()"><span class="ll-icon">‚è≠Ô∏è</span><span>Skip Tile</span><span class="ll-cost">120 XP</span></button></div></div></div>
<div class="modal-ol" id="htpModal"><div class="modal-box"><button class="modal-close" onclick="closeHTP()">‚úï</button><div class="modal-title">How Questly Works</div><div class="modal-section"><h3>üéÆ The Board</h3><p>You play on a 3√ó3 board. Tap a square to reveal a question.</p></div><div class="modal-section"><h3>‚úÖ Claiming Squares</h3><p>Answer correctly ‚Üí you claim the square with <strong>X</strong>.<br>Answer wrong or time runs out ‚Üí the square is marked <strong>O</strong>.</p></div><div class="modal-section"><h3>üèÜ Winning</h3><p>Connect 3 X's in a row (horizontal, vertical, or diagonal) to win the day.</p></div><div class="modal-section"><h3>üõü Lifelines</h3><p>You get two lifelines each day:<br><strong>50:50</strong> ‚Äî removes two wrong answers (costs 80 XP).<br><strong>Skip Tile</strong> ‚Äî skip the question (costs 120 XP). A new question replaces it and you can try the tile again.<br>Each lifeline can be used only once per day.</p></div><div class="modal-section"><h3>‚è±Ô∏è Timer</h3><p>You have 12 seconds per question. If time runs out, the square is marked O.</p></div><div class="modal-section"><h3>üìÖ Daily Play</h3><p>You can play only once per day. Come back tomorrow to continue your streak and claim your daily XP.</p></div></div></div>
<div class="tut-ol" id="tutModal"><div class="tut-box"><div class="tut-emoji">üß†</div><div class="tut-title">Welcome to Questly!</div><div class="tut-desc">A daily tic-tac-toe game powered by trivia.</div><div class="tut-steps"><div class="tut-step"><div class="tut-step-num">1</div><div>Tap a square to reveal a question</div></div><div class="tut-step"><div class="tut-step-num">2</div><div>Answer correctly to claim it with <strong>X</strong></div></div><div class="tut-step"><div class="tut-step-num">3</div><div>Wrong answer or timeout marks it <strong>O</strong></div></div><div class="tut-step"><div class="tut-step-num">4</div><div>Connect 3 X's in a row to win!</div></div></div><button class="btn-p" onclick="closeTutorial()">Got it, let's play!</button></div></div>
<div class="overlay" id="loginOL"><div class="sheet"><div class="s-handle"></div><div class="s-title">Don't lose your streak</div><div class="s-desc" id="loginDesc">Create an account so your streak is never lost.</div><div class="login-hl"><div class="lh-item"><div class="lh-ic">üî•</div><div class="lh-tx">Keep streak</div></div><div class="lh-item"><div class="lh-ic">‚ö°</div><div class="lh-tx">Save XP</div></div><div class="lh-item"><div class="lh-ic">üìä</div><div class="lh-tx">Track stats</div></div></div><div id="phoneG"><input type="email" class="ph-input" placeholder="Enter your email" id="emailIn"><button class="btn-p" onclick="sendMagicLink()">Send login link</button></div><div class="otp-g" id="otpG"><div class="otp-note">‚úâÔ∏è Magic link sent to <strong id="otpPh"></strong></div><div style="font-size:13px;font-weight:300;color:var(--t3);text-align:center;margin-top:8px;line-height:1.5">Check your inbox and click the link.<br>You'll be logged in automatically.</div><div style="text-align:center;margin-top:12px"><button class="otp-resend" onclick="sendMagicLink()">Resend link</button></div></div><button class="s-dismiss" onclick="closeLogin()">Not now</button><div class="login-terms">By continuing you agree to our <a href="#">Terms</a> & <a href="#">Privacy</a></div></div></div>
<div class="toast" id="toastEl"></div>
<script>
function getRef(){try{return new URLSearchParams(window.location.search).get('ref')}catch(e){return null}}
var _ref=getRef();if(_ref){try{localStorage.setItem('questly_ref',_ref)}catch(e){}}
if(window.location.pathname==='/auth'){setTimeout(function(){try{window.history.replaceState({},document.title,'/')}catch(e){}},50)}
var shareURL=window.location.origin+(window.location.pathname==='/'?'':window.location.pathname);

// SUPABASE (PRESERVED)
var SB_URL='https://aymztaxwncpsegnibbut.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5bXp0YXh3bmNwc2VnbmliYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzQwNDMsImV4cCI6MjA4NjcxMDA0M30.rMkRjk6_dfMndTFxinSHiT4jpcDAxeE1hYTmGIbbwH4';
var sb=window.supabase.createClient(SB_URL,SB_KEY);
async function sbSendMagicLink(email){var r=await sb.auth.signInWithOtp({email:email,options:{emailRedirectTo:window.location.origin+'/auth'}});return r.error}
async function sbGetUser(){var r=await sb.auth.getUser();return r.data.user}
async function sbGetSession(){var r=await sb.auth.getSession();return r.data.session}
async function sbFetchProfile(uid){var r=await sb.from('users').select('*').eq('id',uid).single();if(r.error&&r.error.code==='PGRST116')return null;return r.data}
async function sbUpsertProfile(uid,f){var r=await sb.from('users').upsert(Object.assign({id:uid},f),{onConflict:'id'});if(r.error)console.error('sbUpsert:',r.error)}
async function sbSyncToCloud(){var u=await sbGetUser();if(!u)return;await sbUpsertProfile(u.id,{email:G.email||u.email||'',streak:G.streak,xp:G.xp,played_date:G.playedDate,score:0})}
async function sbSyncFromCloud(){var u=await sbGetUser();if(!u)return false;var p=await sbFetchProfile(u.id);if(!p)return false;G.email=p.email||u.email||G.email;G.streak=p.streak!=null?p.streak:G.streak;G.xp=p.xp!=null?p.xp:G.xp;G.playedDate=p.played_date||G.playedDate;G.logged=true;save();return true}

// ANONYMOUS PLAYER ID for server-side daily lock
function getPlayerId(){var id=localStorage.getItem('questly_player_id');if(!id){id='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)});localStorage.setItem('questly_player_id',id)}return id}

// Check if already played today (server-side)
async function checkServerPlayed(){try{var r=await sb.from('daily_attempts').select('score').eq('player_id',getPlayerId()).eq('date',localDate());if(r.data&&r.data.length>0)return r.data[0].score;return null}catch(e){return null}}
// Record attempt to server
async function recordAttempt(score){try{await sb.from('daily_attempts').insert({player_id:getPlayerId(),date:localDate(),score:score})}catch(e){console.error('recordAttempt:',e)}}

// QUESTIONS ‚Äî Indianized, 18 total, mixed difficulty (easy/medium/hard)
var ALL_Q=[
{cat:"Bollywood",q:"Which Bollywood film features the iconic dialogue \"Kitne aadmi the\"?",o:["Deewar","Sholay","Don","Zanjeer"],a:1},
{cat:"Bollywood",q:"Who directed the 2001 blockbuster \"Lagaan\"?",o:["Sanjay Leela Bhansali","Rakeysh Omprakash Mehra","Ashutosh Gowariker","Rajkumar Hirani"],a:2},
{cat:"Cricket",q:"Who holds the record for most runs in international cricket?",o:["Ricky Ponting","Sachin Tendulkar","Virat Kohli","Kumar Sangakkara"],a:1},
{cat:"Cricket",q:"In which year did India win their first ICC T20 World Cup?",o:["2007","2009","2011","2013"],a:0},
{cat:"Indian Food",q:"Which Indian bread is traditionally made in a tandoor oven?",o:["Paratha","Naan","Puri","Chapati"],a:1},
{cat:"Indian Food",q:"Rogan Josh is a famous curry dish originating from which region?",o:["Punjab","Rajasthan","Kashmir","Goa"],a:2},
{cat:"Tech & Apps",q:"Which Indian company developed the UPI payments system?",o:["Paytm","NPCI","Infosys","Razorpay"],a:1},
{cat:"Tech & Apps",q:"Zerodha is India's largest platform for which service?",o:["Food Delivery","Online Shopping","Stock Trading","Hotel Booking"],a:2},
{cat:"Indian Brands",q:"Amul is headquartered in which Indian state?",o:["Maharashtra","Gujarat","Rajasthan","Karnataka"],a:1},
{cat:"Indian Brands",q:"Which Indian company makes the \"Tata Nano\" car?",o:["Mahindra","Maruti Suzuki","Tata Motors","Hindustan Motors"],a:2},
{cat:"School GK",q:"How many states are there in India as of 2024?",o:["28","29","30","31"],a:0},
{cat:"School GK",q:"Which planet is known as the \"Red Planet\"?",o:["Venus","Mars","Jupiter","Saturn"],a:1},
{cat:"Geography",q:"Which is the longest river in India?",o:["Yamuna","Godavari","Ganga","Brahmaputra"],a:2},
{cat:"Geography",q:"Jog Falls, one of India's highest waterfalls, is in which state?",o:["Kerala","Tamil Nadu","Karnataka","Goa"],a:2},
{cat:"History",q:"Who was the first President of independent India?",o:["Dr. Rajendra Prasad","Jawaharlal Nehru","Sardar Patel","B.R. Ambedkar"],a:0},
{cat:"History",q:"The Jallianwala Bagh massacre took place in which city?",o:["Delhi","Lahore","Amritsar","Lucknow"],a:2},
{cat:"Sports",q:"How many players are there in a standard Kabaddi team on the court?",o:["5","6","7","8"],a:2},
{cat:"Sports",q:"P.V. Sindhu won an Olympic medal in which sport?",o:["Tennis","Table Tennis","Badminton","Archery"],a:2}
];
var CAT_E={"Bollywood":"üé¨","Cricket":"üèè","Indian Food":"üçõ","Tech & Apps":"üíª","Indian Brands":"üè∑Ô∏è","School GK":"üìö","Geography":"üó∫Ô∏è","History":"üèõÔ∏è","Sports":"üèÖ"};
var LS='questly_ttt_v5',Q_TIME=12,START_XP=200,FIFTY_COST=80,SKIP_COST=120;
var WIN_LINES=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function $(id){return document.getElementById(id)}
function localDate(d){d=d||new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function yday(){var d=new Date();d.setDate(d.getDate()-1);return localDate(d)}
function go(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active','fade')});$(id).classList.add('active','fade');window.scrollTo(0,0)}
function midCd(){var n=new Date(),t=new Date(n);t.setDate(t.getDate()+1);t.setHours(0,0,0,0);var d=Math.max(0,t-n),h=Math.floor(d/36e5),m=Math.floor((d%36e5)/6e4),s=Math.floor((d%6e4)/1e3);return h+'h '+String(m).padStart(2,'0')+'m '+String(s).padStart(2,'0')+'s'}
function toast(m){var t=$('toastEl');t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2500)}
var _fired={};
function log(e,d){console.log('[Q] '+e,d||'');try{if(window.posthog&&posthog.capture)posthog.capture(e,d||{})}catch(x){}}
function logOnce(e,d){var k=e+JSON.stringify(d||{});if(_fired[k])return;_fired[k]=true;log(e,d)}

function seededRNG(seed){var s=0;for(var i=0;i<seed.length;i++)s=((s<<5)-s)+seed.charCodeAt(i);s=Math.abs(s)||1;return function(){s=(s*1103515245+12345)&0x7fffffff;return(s&0xfffffff)/0x10000000}}
var _dailyBoard=null,_dailyBoardDate='',_dailySpares=[];
function getDailyBoard(){var today=localDate();if(_dailyBoard&&_dailyBoardDate===today)return _dailyBoard;var rng=seededRNG(today);
// Step 1: shuffle all question indices
var idx=[];for(var i=0;i<ALL_Q.length;i++)idx.push(i);
for(var i=idx.length-1;i>0;i--){var j=Math.floor(rng()*(i+1));var tmp=idx[i];idx[i]=idx[j];idx[j]=tmp}
var picked=idx.slice(0,9);
// Store remaining as spares for skip tile (#3)
_dailySpares=idx.slice(9);
// Step 2: Balanced answer distribution (#1)
// Create target correct positions: [0,0,1,1,2,2,3,3] + 1 random = 9 slots
// Each of A/B/C/D gets 2-3 correct answers
var slots=[0,0,1,1,2,2,3,3];
var extra=Math.floor(rng()*4);slots.push(extra);
// Shuffle slots deterministically
for(var i=slots.length-1;i>0;i--){var j=Math.floor(rng()*(i+1));var tmp=slots[i];slots[i]=slots[j];slots[j]=tmp}
// Step 3: Build board ‚Äî place correct answer at target slot, fill others
_dailyBoard=picked.map(function(qi,tileIdx){
  var orig=ALL_Q[qi];var targetPos=slots[tileIdx];
  var correctText=orig.o[orig.a];
  var wrongs=[];for(var i=0;i<orig.o.length;i++){if(i!==orig.a)wrongs.push(orig.o[i])}
  // Shuffle wrongs deterministically
  for(var i=wrongs.length-1;i>0;i--){var j=Math.floor(rng()*(i+1));var tmp=wrongs[i];wrongs[i]=wrongs[j];wrongs[j]=tmp}
  // Build options array with correct at targetPos
  var opts=[];var wi=0;
  for(var i=0;i<4;i++){if(i===targetPos)opts.push(correctText);else{opts.push(wrongs[wi]);wi++}}
  return{cat:orig.cat,q:orig.q,o:opts,a:targetPos,origIdx:qi};
});_dailyBoardDate=today;return _dailyBoard}
// Get a spare question for skip tile (#3) ‚Äî returns new board entry or null
function getSpareQuestion(tileIdx,rng2){
  if(_dailySpares.length===0)return null;
  var qi=_dailySpares.shift(); // take first spare, remove from pool
  var orig=ALL_Q[qi];
  // Random correct position
  var targetPos=Math.floor(rng2()*4);
  var correctText=orig.o[orig.a];
  var wrongs=[];for(var i=0;i<orig.o.length;i++){if(i!==orig.a)wrongs.push(orig.o[i])}
  for(var i=wrongs.length-1;i>0;i--){var j=Math.floor(rng2()*(i+1));var tmp=wrongs[i];wrongs[i]=wrongs[j];wrongs[j]=tmp}
  var opts=[];var wi=0;
  for(var i=0;i<4;i++){if(i===targetPos)opts.push(correctText);else{opts.push(wrongs[wi]);wi++}}
  return{cat:orig.cat,q:orig.q,o:opts,a:targetPos,origIdx:qi};
}

// STATE
var G={logged:false,email:'',xp:START_XP,streak:0,playedDate:'',gameDate:'',board:['','','','','','','','',''],skippedTiles:[],discardedQs:[],moveCount:0,activeTile:-1,usedFifty:false,usedSkip:false,fiftyHidden:[],result:'',gameStarted:false,answered:false,firstVisit:true,serverRecorded:false,xpEarned:0};
function save(){try{localStorage.setItem(LS,JSON.stringify({logged:G.logged,email:G.email,xp:G.xp,streak:G.streak,playedDate:G.playedDate,gameDate:G.gameDate,board:G.board,skippedTiles:G.skippedTiles,discardedQs:G.discardedQs,moveCount:G.moveCount,activeTile:G.activeTile,usedFifty:G.usedFifty,usedSkip:G.usedSkip,fiftyHidden:G.fiftyHidden,result:G.result,gameStarted:G.gameStarted,answered:G.answered,firstVisit:G.firstVisit,serverRecorded:G.serverRecorded,xpEarned:G.xpEarned}))}catch(e){}}
function load(){try{var r=localStorage.getItem(LS);if(r)return JSON.parse(r)}catch(e){}return null}
function checkWin(mark){for(var i=0;i<WIN_LINES.length;i++){var l=WIN_LINES[i];if(G.board[l[0]]===mark&&G.board[l[1]]===mark&&G.board[l[2]]===mark)return l}return null}
function isBoardFull(){for(var i=0;i<9;i++)if(G.board[i]==='')return false;return true}
function getScore(){var s=0;for(var i=0;i<9;i++)if(G.board[i]==='x')s++;return s}
// XP reward based on score (#5)
function calcXpReward(sc){if(sc>=9)return 50;if(sc>=7)return 35;if(sc>=5)return 20;if(sc>=3)return 10;return 5}

// Streak protection eligibility
function shouldShowSaveStreak(){return !G.logged&&G.streak>=3}

function renderHeader(tid){var el=$(tid);if(!el)return;el.innerHTML='<div class="h-pill">üî• <span class="v">'+G.streak+'</span></div><div class="h-pill">ü™ô <span class="xv">'+G.xp+'</span></div>'}

// RENDER BOARD ‚Äî #3: show category names instead of ? on unclaimed tiles
function renderBoard(){
  var db=getDailyBoard(),h='';
  for(var i=0;i<9;i++){
    var val=G.board[i],isSkip=G.skippedTiles.indexOf(i)>=0,q=db[i],cat=q.cat,em=CAT_E[cat]||'‚ùì';
    var cls='tile';
    if(val==='x')cls+=' x claimed';
    else if(val==='o'&&!isSkip)cls+=' o claimed';
    else if(isSkip&&val==='')cls+=' skipped'; // #4: skipped tile is replayable
    if(G.result)cls+=' locked';
    var inner='';
    if(val==='x'){inner='<span class="tile-icon">‚úï</span><span class="tile-cat">'+em+' '+cat+'</span>'}
    else if(val==='o'){inner='<span class="tile-icon">‚óã</span><span class="tile-cat">'+em+' '+cat+'</span>'}
    else if(isSkip){
      // #4: Skipped tile ‚Äî replayable. Shows "Play this tile" on top, category in middle, "Skipped" on bottom
      inner='<span class="tile-icon">Play again</span><span class="tile-cat">'+em+' '+cat+'</span><span class="tile-label">Skipped</span>';
    } else {
      // #3: Show category name instead of ?
      inner='<span class="tile-icon" style="font-size:16px">'+em+'</span><span class="tile-cat" style="opacity:1">'+cat+'</span>';
    }
    h+='<div class="'+cls+'" onclick="tileClick('+i+')">'+inner+'</div>';
  }
  return h;
}

// HOME SCREEN
function showHome(){
  renderHeader('hRight');
  if(G.gameStarted||G.result){showPlayScreen();return}
  var h='<div class="home-headline">Questly</div><div class="home-sub">Beat the system at tic-tac-toe using your knowledge.</div><div class="home-cta"><button class="btn-p" onclick="openBoard()">Play Today\'s Puzzle</button></div>';
  // #5.3: Persistent save streak button on home if eligible
  if(shouldShowSaveStreak())h+='<div class="home-save"><button class="btn-o" onclick="openLogin()">üîí Save your streak</button></div>';
  h+='<button class="htp-btn" onclick="openHTP()">How to Play</button>';
  $('homeBody').innerHTML=h;go('sHome');logOnce('home_viewed');
}

// OPEN BOARD ‚Äî with server-side check
async function openBoard(){
  if(G.firstVisit){G.firstVisit=false;save();showTutorial();return}
  // Server-side daily lock: check if already played
  var serverScore=await checkServerPlayed();
  if(serverScore!==null){
    toast("You already played today's puzzle.");
    // Reconstruct done state
    G.result=G.result||'loss';G.playedDate=localDate();save();
    showPlayScreen();return;
  }
  G.gameStarted=true;G.gameDate=localDate();save();
  log('play_pressed');log('daily_board_started');showPlayScreen();
}

// PLAY SCREEN
function showPlayScreen(){
  renderHeader('hRightPlay');
  var today=localDate(),done=G.playedDate===today&&G.result!=='',h='';
  if(done){
    var isW=G.result==='win',sc=getScore();
    h+='<div class="done-msg'+(isW?'':' loss')+'"><div class="dm-title">'+(isW?'‚úÖ Victory!':'‚ùå You ran out of correct answers today.')+'</div><div class="dm-sub">'+(isW?'Your streak continues!':'Come back tomorrow and try again.')+'</div></div>';
    h+='<div class="board-wrapper"><div class="board" id="boardGrid">'+renderBoard()+'</div></div>';
    h+='<div style="font-size:13px;color:var(--t3);margin-bottom:16px">Next puzzle: <span class="time" id="playCd" style="color:var(--red);font-weight:600">'+midCd()+'</span></div>';
    h+='<div style="display:flex;gap:8px;width:100%;max-width:300px"><button class="btn-o" style="flex:1" onclick="shareToClipboard()">üìã Share</button><button class="btn-o" style="flex:1" onclick="showResult()">View Result</button></div>';
  } else {
    h+='<div class="board-wrapper"><div class="play-title">Today\'s Puzzle</div><div class="play-sub">Tap a square</div><div class="board" id="boardGrid">'+renderBoard()+'</div></div>';
  }
  $('playBody').innerHTML=h;go('sPlay');
  if(G.result==='win'){var wl=checkWin('x');if(wl)setTimeout(function(){var tiles=document.querySelectorAll('.tile');wl.forEach(function(i){if(tiles[i])tiles[i].classList.add('win-highlight')})},100)}
  if(done){clearInterval(G._cdI);G._cdI=setInterval(function(){var e=$('playCd');if(e)e.textContent=midCd()},1000)}
}

// TILE CLICK ‚Äî #4: skipped tiles are replayable
var _tileGuard=0;
function tileClick(idx){
  var now=Date.now();if(now-_tileGuard<300)return;_tileGuard=now;
  if(!G.gameStarted||G.result)return;
  // Allow click on empty tiles OR skipped tiles (replayable)
  var isSkip=G.skippedTiles.indexOf(idx)>=0;
  if(G.board[idx]!==''&&!isSkip)return;
  if(G.board[idx]===''&&!isSkip&&G.activeTile>=0&&G.activeTile!==idx)return;
  if(G.activeTile===idx){showQuestion();return}
  G.activeTile=idx;G.answered=false;G.fiftyHidden=[];G.moveCount++;save();
  log('tile_selected',{tile_position:idx,move_number:G.moveCount});
  showQuestion();
}

// TIMER
var _timerInt=null,_timerStart=0;
function startTimer(){clearInterval(_timerInt);var fill=$('qTimerFill');fill.style.transition='none';fill.style.width='100%';fill.classList.remove('urgent');fill.offsetHeight;fill.style.transition='width 0.1s linear';_timerStart=Date.now();_timerInt=setInterval(function(){if(G.answered){clearInterval(_timerInt);return}var el=(Date.now()-_timerStart)/1000,pct=Math.max(0,(1-el/Q_TIME)*100);fill.style.width=pct+'%';if(pct<30)fill.classList.add('urgent');if(el>=Q_TIME){clearInterval(_timerInt);timeUp()}},100)}
function stopTimer(){clearInterval(_timerInt)}
function timeUp(){if(G.answered)return;G.answered=true;var ti=G.activeTile,db=getDailyBoard(),q=db[ti];var opts=document.querySelectorAll('.q-opt');opts.forEach(function(b,j){b.classList.add('off');if(j===q.a)b.classList.add('reveal')});$('lifelines').style.display='none';G.board[ti]='o';
// Remove from skipped if it was a retry
var si=G.skippedTiles.indexOf(ti);if(si>=0)G.skippedTiles.splice(si,1);
log('question_answered',{correct:false,category:q.cat,tile_position:ti,move_number:G.moveCount,timeout:true});save();setTimeout(function(){closeQuestion();afterAnswer(ti)},1400)}

function showQuestion(){var ti=G.activeTile;if(ti<0)return;var db=getDailyBoard(),q=db[ti];$('qCat').innerHTML=(CAT_E[q.cat]||'')+' '+q.cat;$('qMove').textContent='Move '+G.moveCount+' of 9';$('qText').textContent=q.q;var keys=['A','B','C','D'],el=$('qOpts');el.innerHTML='';q.o.forEach(function(opt,i){var b=document.createElement('button');b.className='q-opt';if(G.fiftyHidden.indexOf(i)>=0)b.classList.add('fifty-hidden');b.innerHTML='<span class="q-key">'+keys[i]+'</span><span>'+opt+'</span>';b.onclick=function(){answerQuestion(i)};if(G.answered)b.classList.add('off');el.appendChild(b)});updateLL();$('lifelines').style.display=G.answered?'none':'flex';$('qOverlay').classList.add('active');if(!G.answered){startTimer()}else{$('qTimerFill').style.width='0%'}}
function updateLL(){$('llFifty').disabled=G.usedFifty||G.xp<FIFTY_COST||G.answered;$('llSkip').disabled=G.usedSkip||G.xp<SKIP_COST||G.answered}

var _lastPick=0;
function answerQuestion(i){if(G.answered)return;var now=Date.now();if(now-_lastPick<200)return;_lastPick=now;stopTimer();G.answered=true;var ti=G.activeTile,db=getDailyBoard(),q=db[ti],correct=i===q.a;var opts=document.querySelectorAll('.q-opt');opts.forEach(function(b,j){b.classList.add('off');if(j===q.a)b.classList.add('correct');if(j===i&&!correct){b.classList.add('wrong');opts[q.a].classList.add('reveal')}});$('lifelines').style.display='none';G.board[ti]=correct?'x':'o';
// Remove from skipped if retried
var si=G.skippedTiles.indexOf(ti);if(si>=0)G.skippedTiles.splice(si,1);
log('question_answered',{correct:correct,category:q.cat,tile_position:ti,move_number:G.moveCount,used_5050:G.fiftyHidden.length>0,used_skip:false});save();if(!correct){$('qOpts').classList.add('shake');setTimeout(function(){$('qOpts').classList.remove('shake')},250)}setTimeout(function(){closeQuestion();afterAnswer(ti)},correct?1000:1400)}

function afterAnswer(ti){setTimeout(function(){var tiles=document.querySelectorAll('.tile');if(tiles[ti])tiles[ti].classList.add('claim-anim')},50);var xW=checkWin('x'),oW=checkWin('o');
if(xW){G.result='win';G.streak++;var sc=getScore();var reward=calcXpReward(sc);G.xp+=reward;G.xpEarned=reward;G.playedDate=localDate();save();if(G.logged)sbSyncToCloud();recordResult();log('game_won',{moves_taken:G.moveCount,streak_after:G.streak,xp_earned:reward});setTimeout(function(){showConfetti();showResult()},500)}
else if(oW||isBoardFull()){G.result='loss';var sc=getScore();var reward=calcXpReward(sc);G.xp+=reward;G.xpEarned=reward;G.playedDate=localDate();save();if(G.logged)sbSyncToCloud();recordResult();log('game_lost',{moves_taken:G.moveCount,final_board_state:G.board.join(','),xp_earned:reward});setTimeout(function(){showResult()},600)}
else{showPlayScreen()}}

// Record result to server (once)
function recordResult(){if(!G.serverRecorded){G.serverRecorded=true;save();recordAttempt(getScore())}}

function closeQuestion(){G.activeTile=-1;G.answered=false;G.fiftyHidden=[];stopTimer();save();$('qOverlay').classList.remove('active')}

// 50:50
function useFiftyFifty(){if(G.usedFifty||G.xp<FIFTY_COST||G.answered)return;var ti=G.activeTile;if(ti<0)return;var db=getDailyBoard(),q=db[ti],xpB=G.xp;G.usedFifty=true;G.xp-=FIFTY_COST;var wrong=[];for(var i=0;i<4;i++)if(i!==q.a&&G.fiftyHidden.indexOf(i)<0)wrong.push(i);for(var i=wrong.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=wrong[i];wrong[i]=wrong[j];wrong[j]=t}G.fiftyHidden=wrong.slice(0,2);save();var opts=document.querySelectorAll('.q-opt');G.fiftyHidden.forEach(function(idx){if(opts[idx])opts[idx].classList.add('fifty-hidden')});log('lifeline_used',{type:'50:50',xp_before:xpB,xp_after:G.xp,tile_position:ti,move_number:G.moveCount});updateLL();renderHeader('hRightPlay');toast('Two options removed!')}

// SKIP TILE (#3 new): discard current question, assign NEW unused question, tile stays empty
function useSkipTile(){if(G.usedSkip||G.xp<SKIP_COST||G.answered||G.activeTile<0)return;stopTimer();var xpB=G.xp,ti=G.activeTile;G.usedSkip=true;G.xp-=SKIP_COST;
// Discard current question permanently
var db=getDailyBoard();var oldQ=db[ti];
G.discardedQs.push(oldQ.origIdx);
// Assign a new spare question to this tile
var rng2=seededRNG(localDate()+'skip'+ti+G.moveCount);
var spare=getSpareQuestion(ti,rng2);
if(spare){db[ti]=spare}// If no spares left, tile keeps old question (shouldn't happen with 18 questions)
// Tile stays empty ‚Äî replayable with new question
G.board[ti]='';
if(G.skippedTiles.indexOf(ti)<0)G.skippedTiles.push(ti);
log('lifeline_used',{type:'skip_tile',xp_before:xpB,xp_after:G.xp,tile_position:ti,move_number:G.moveCount});
G.activeTile=-1;G.answered=false;G.fiftyHidden=[];G.moveCount--;save();
$('qOverlay').classList.remove('active');toast('New question assigned ‚Äî tap the tile again!');showPlayScreen()}

// RESULT SCREEN ‚Äî with XP reward display (#5)
function showResult(){
  renderHeader('hRightRes');var isW=G.result==='win',sc=getScore(),h='';
  h+='<div class="r-emoji">'+(isW?'üèÜ':'üòî')+'</div>';
  h+='<div class="r-title">'+(isW?'Mission Accomplished!':'Puzzle Complete')+'</div>';
  h+='<div class="r-sub">'+(isW?'Your streak continues. Great strategy!':'You ran out of correct answers today.')+'</div>';
  h+='<div class="r-moves">You got '+sc+'/9 correct in '+G.moveCount+' move'+(G.moveCount===1?'':'s')+'.</div>';
  h+='<div class="r-board-mini">';
  for(var i=0;i<9;i++){var v=G.board[i],isSk=G.skippedTiles.indexOf(i)>=0,cls=v==='x'?'rx':v==='o'?'ro':'re',txt=v==='x'?'‚úï':v==='o'?'‚óã':'';h+='<div class="r-cell '+cls+'">'+txt+'</div>'}
  h+='</div>';
  if(isW)h+='<div class="r-streak-box"><div class="r-streak-num">üî• '+G.streak+'</div><div class="r-streak-label">Day Streak</div></div>';
  // XP earned message (#5)
  h+='<div style="font-size:15px;font-weight:600;color:var(--gold);margin-bottom:12px">You earned +'+G.xpEarned+' XP today ‚ö°</div>';
  h+='<div class="r-xp-line">ü™ô <strong>'+G.xp+' XP</strong> balance</div>';
  h+='<div class="r-bonus-msg">Come back tomorrow to claim <strong>50 XP</strong> daily bonus and continue your streak.</div>';
  h+='<div class="r-cd">Next puzzle: <span class="time" id="rCd">'+midCd()+'</span></div>';
  h+='<div class="r-actions">';
  if(shouldShowSaveStreak())h+='<button class="btn-p" onclick="openLogin()">üîí Save your streak now</button>';
  h+='<button class="btn-o" onclick="shareToClipboard()">üìã Share Result</button>';
  h+='<button class="btn-t" onclick="showPlayScreen()">View Board</button></div>';
  $('resBody').innerHTML=h;go('sRes');
  if(isW){var wl=checkWin('x');if(wl){var cells=document.querySelectorAll('.r-cell');wl.forEach(function(i){if(cells[i])cells[i].style.boxShadow='0 0 0 2px var(--green)'})}}
  clearInterval(G._cdI);G._cdI=setInterval(function(){var e=$('rCd');if(e)e.textContent=midCd()},1000);
  logOnce('result_screen_viewed',{result:G.result,streak:G.streak,xp_balance:G.xp,xp_earned:G.xpEarned})}

// SHARE ‚Äî clean plain text format (#4)
function getShareText(){
  var grid=G.board.map(function(v){return v==='x'?'üü©':v==='o'?'üü•':'‚¨ú'});
  var r1=grid.slice(0,3).join(''),r2=grid.slice(3,6).join(''),r3=grid.slice(6,9).join('');
  var sc=getScore();
  return 'üß† Questly \u2014 Today\u0027s Puzzle\n\n'+r1+'\n'+r2+'\n'+r3+'\n\nI scored '+sc+'/9 today.\n\nTry it:\n'+shareURL+'\n'}
function shareToClipboard(){log('share_clicked',{type:'clipboard'});var text=getShareText();if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){toast('Copied! Paste on WhatsApp or your status.')}).catch(function(){fallbackCopy(text)})}else{fallbackCopy(text)}}
function fallbackCopy(text){var ta=document.createElement('textarea');ta.value=text;ta.style.position='fixed';ta.style.left='-999px';document.body.appendChild(ta);ta.select();try{document.execCommand('copy');toast('Copied! Paste on WhatsApp or your status.')}catch(e){toast('Could not copy.')}document.body.removeChild(ta)}

function openHTP(){$('htpModal').classList.add('active')}
function closeHTP(){$('htpModal').classList.remove('active')}
$('htpModal').addEventListener('click',function(e){if(e.target===this)closeHTP()});
function showTutorial(){$('tutModal').classList.add('active')}
function closeTutorial(){$('tutModal').classList.remove('active');G.gameStarted=true;G.gameDate=localDate();save();log('play_pressed');log('daily_board_started');showPlayScreen()}
function showConfetti(){var c=document.createElement('div');c.className='confetti-container';document.body.appendChild(c);var colors=['#e85d2a','#2d9b5a','#c49a20','#d44040','#3b82f6','#9b5de5','#00bbf9','#f15bb5'];for(var i=0;i<40;i++){var p=document.createElement('div');p.className='confetti-piece';p.style.left=Math.random()*100+'%';p.style.background=colors[Math.floor(Math.random()*colors.length)];p.style.animationDelay=(Math.random()*0.8)+'s';p.style.animationDuration=(2+Math.random()*1.5)+'s';p.style.width=(6+Math.random()*8)+'px';p.style.height=(6+Math.random()*8)+'px';if(Math.random()>0.5)p.style.borderRadius='50%';c.appendChild(p)}setTimeout(function(){c.remove()},4000)}

// LOGIN ‚Äî #5.6: dynamic microcopy
function openLogin(){log('login_opened');$('loginDesc').textContent='You have a '+G.streak+'-day streak. Create an account so it\'s never lost.';$('phoneG').style.display='block';$('otpG').classList.remove('active');$('emailIn').value='';$('loginOL').classList.add('active')}
function closeLogin(){$('loginOL').classList.remove('active')}
async function sendMagicLink(){var email=$('emailIn').value.trim();if(!email||!email.includes('@')){toast('Enter a valid email');return}G.email=email;var btn=$('phoneG').querySelector('.btn-p');btn.textContent='Sending...';btn.disabled=true;var err=await sbSendMagicLink(email);btn.textContent='Send login link';btn.disabled=false;if(err){toast('Failed: '+err.message);return}$('otpPh').textContent=email;$('phoneG').style.display='none';$('otpG').classList.add('active');toast('Check your email!')}
// #5.5: After login, hide save streak buttons, refresh screens
sb.auth.onAuthStateChange(async function(event,session){if(event==='SIGNED_IN'&&session&&!G.logged){G.logged=true;G.email=session.user.email||G.email;try{if(window.posthog){posthog.identify(session.user.id,{email:session.user.email});posthog.capture('login_success')}}catch(x){}var existing=await sbFetchProfile(session.user.id);if(existing&&existing.streak>G.streak){await sbSyncFromCloud()}else{await sbSyncToCloud()}save();closeLogin();toast('Signed in!');
// Re-render current screen to hide save streak buttons
var today=localDate(),done=G.playedDate===today&&G.result!=='';
if(done){if($('sRes').classList.contains('active'))showResult();else showPlayScreen()}else showHome()}});
$('loginOL').addEventListener('click',function(e){if(e.target===this)closeLogin()});

// INIT
function initApp(){
  var s=load();if(s){for(var k in s){if(s[k]!==undefined)G[k]=s[k]}}
  var today=localDate();
  log('app_opened',{date:today,streak:G.streak,xp_balance:G.xp,has_played_today:G.playedDate===today&&G.result!==''});
  if(G.gameDate&&G.gameDate!==today){resetForNewDay()}
  if(G.playedDate&&G.playedDate!==today&&G.playedDate!==yday()&&G.result!==''){G.streak=0;save()}
  G.gameDate=localDate();getDailyBoard();
  (async function(){
    var session=await sbGetSession();
    if(session&&session.user){G.logged=true;G.email=session.user.email||G.email;try{await sbSyncFromCloud()}catch(e){}}
    var done=G.playedDate===today&&G.result!=='';
    if(done){showPlayScreen()}
    else if(G.gameStarted&&G.activeTile>=0){showPlayScreen();setTimeout(function(){showQuestion()},150)}
    else if(G.gameStarted){showPlayScreen()}
    else{go('sHome');renderHeader('hRight');
      // Build home content with save streak button if needed
      var h='<div class="home-headline">Questly</div><div class="home-sub">Beat the system at tic-tac-toe using your knowledge.</div><div class="home-cta"><button class="btn-p" onclick="openBoard()">Play Today\'s Puzzle</button></div>';
      if(shouldShowSaveStreak())h+='<div class="home-save"><button class="btn-o" onclick="openLogin()">üîí Save your streak</button></div>';
      h+='<button class="htp-btn" onclick="openHTP()">How to Play</button>';
      $('homeBody').innerHTML=h;
      logOnce('home_viewed')}
    scheduleMN()})()}
function resetForNewDay(){G.board=['','','','','','','','',''];G.skippedTiles=[];G.discardedQs=[];G.moveCount=0;G.activeTile=-1;G.usedFifty=false;G.usedSkip=false;G.fiftyHidden=[];G.result='';G.gameStarted=false;G.answered=false;G.serverRecorded=false;G.xpEarned=0;_dailyBoard=null;_dailySpares=[];save()}
function scheduleMN(){var n=new Date(),t=new Date(n);t.setDate(t.getDate()+1);t.setHours(0,0,0,100);setTimeout(function(){resetForNewDay();G.gameDate=localDate();_dailyBoard=null;showHome();scheduleMN()},Math.min(t-n,864e5))}
window.addEventListener('beforeunload',function(){save()});
document.addEventListener('visibilitychange',function(){if(document.hidden)save()});
initApp();
</script></body></html>
